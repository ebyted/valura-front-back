services:
  # Note: Traefik is usually managed by Dokploy, so this service might not be needed
  # Keep it commented out for Dokploy deployment
  # traefik:
  #   image: traefik:v3.0
  #   command:
  #     - "--api.dashboard=true"
  #     - "--api.insecure=false" # Security: disabled for production
  #     - "--providers.docker=true"
  #     - "--providers.docker.exposedbydefault=false"
  #     - "--entrypoints.web.address=:80"
  #     - "--entrypoints.websecure.address=:443"
  #     - "--certificatesresolvers.letsencrypt.acme.email=admin@valura.mx"
  #     - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
  #     - "--certificatesresolvers.letsencrypt.acme.tlschallenge=true"
  #     - "--global.sendanonymoususage=false"
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #   networks:
  #     - dokploy-network
  #   volumes:
  #     - /var/run/docker.sock:/var/run/docker.sock:ro
  #     - ./letsencrypt:/letsencrypt
  #   restart: unless-stopped
  #   security_opt:
  #     - no-new-privileges:true

  valura-mail:
    build: 
      context: ./backend
      dockerfile: Dockerfile
    expose:
      - "7099" # Internal container port
    container_name: valura-mail
    environment:
      - NODE_ENV=production
      - PORT=7099
    labels:
      # Traefik configuration
      - "traefik.enable=true"
      - "traefik.docker.network=dokploy-network"
      
      # Service configuration
      - "traefik.http.services.valura-mail.loadbalancer.server.port=7099"
      
      # CORS middleware
      - "traefik.http.middlewares.valura-cors.headers.accessControlAllowOriginList=https://valura.mx,https://www.valura.mx,https://valura.webitofrito.com,https://www.valura.webitofrito.com"
      - "traefik.http.middlewares.valura-cors.headers.accessControlAllowMethods=GET,POST,OPTIONS"
      - "traefik.http.middlewares.valura-cors.headers.accessControlAllowHeaders=Content-Type,Authorization,Accept"
      - "traefik.http.middlewares.valura-cors.headers.accessControlMaxAge=86400"
      
      # Router for API endpoints
      - "traefik.http.routers.valura-mail.rule=Host(`api.valura.mx`) || Host(`api.valura.webitofrito.com`) || (Host(`valura.mx`) && PathPrefix(`/api`)) || (Host(`valura.webitofrito.com`) && PathPrefix(`/api`))"
      - "traefik.http.routers.valura-mail.entrypoints=websecure"
      - "traefik.http.routers.valura-mail.tls=true"
      - "traefik.http.routers.valura-mail.tls.certresolver=letsencrypt"
      - "traefik.http.routers.valura-mail.middlewares=valura-cors@docker"
    networks:
      - dokploy-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7099/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  valura-homepage:
    build: 
      context: ./frontend
      dockerfile: Dockerfile
    expose:
      - "80" # Internal container port
    container_name: valura-homepage
    environment:
      - APACHE_LOG_LEVEL=warn
    labels:
      # Traefik configuration
      - "traefik.enable=true"
      - "traefik.docker.network=dokploy-network"
      
      # Service configuration
      - "traefik.http.services.valura-homepage.loadbalancer.server.port=80"
      
      # Security headers middleware
      - "traefik.http.middlewares.valura-security.headers.frameDeny=true"
      - "traefik.http.middlewares.valura-security.headers.sslRedirect=true"
      - "traefik.http.middlewares.valura-security.headers.browserXssFilter=true"
      - "traefik.http.middlewares.valura-security.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.valura-security.headers.forceSTSHeader=true"
      - "traefik.http.middlewares.valura-security.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.valura-security.headers.stsPreload=true"
      - "traefik.http.middlewares.valura-security.headers.stsSeconds=31536000"
      
      # WWW redirect middleware - redirects www to non-www for both domains
      - "traefik.http.middlewares.valura-www-redirect.redirectregex.regex=^https://www\\.(valura\\.mx|valura\\.webitofrito\\.com)/(.*)"
      - "traefik.http.middlewares.valura-www-redirect.redirectregex.replacement=https://$${1}/$${2}"
      
      # Router for main website
      - "traefik.http.routers.valura-homepage.rule=Host(`valura.mx`) || Host(`www.valura.mx`) || Host(`valura.webitofrito.com`) || Host(`www.valura.webitofrito.com`)"
      - "traefik.http.routers.valura-homepage.entrypoints=websecure"
      - "traefik.http.routers.valura-homepage.tls=true"
      - "traefik.http.routers.valura-homepage.tls.certresolver=letsencrypt"
      - "traefik.http.routers.valura-homepage.middlewares=valura-security@docker,valura-www-redirect@docker"
      
      # HTTP to HTTPS redirect
      - "traefik.http.routers.valura-homepage-http.rule=Host(`valura.mx`) || Host(`www.valura.mx`) || Host(`valura.webitofrito.com`) || Host(`www.valura.webitofrito.com`)"
      - "traefik.http.routers.valura-homepage-http.entrypoints=web"
      - "traefik.http.routers.valura-homepage-http.middlewares=https-redirect@docker"
      - "traefik.http.middlewares.https-redirect.redirectscheme.scheme=https"
    networks:
      - dokploy-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  dokploy-network:
    external: true
    # In Dokploy, this network is usually created automatically
    # If not, create it with: docker network create dokploy-network